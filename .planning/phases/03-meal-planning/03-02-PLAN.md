---
phase: 03-meal-planning
plan: 02
type: execute
wave: 2
depends_on: ["03-01"]
files_modified:
  - src/utils/dateUtils.ts
  - src/hooks/useMealPlans.ts
  - src/components/planner/WeekRow.tsx
  - src/components/planner/DayCell.tsx
  - src/app/(tabs)/planner.tsx
autonomous: true

must_haves:
  truths:
    - "User sees a 4-week calendar on the planner screen"
    - "Calendar shows 2 weeks ago, last week, this week, and next week"
    - "Weeks display Monday through Sunday"
    - "Calendar auto-scrolls to current week on open"
    - "Past days appear dimmed/faded"
    - "Today has a subtle visual highlight"
  artifacts:
    - path: "src/utils/dateUtils.ts"
      provides: "Date calculations for 4-week window"
      exports: ["get4WeekWindow", "formatDateKey", "groupIntoWeeks"]
    - path: "src/hooks/useMealPlans.ts"
      provides: "Convex hook for meal plan data"
      exports: ["useMealPlans", "useSetMeal", "useClearMeal"]
    - path: "src/components/planner/WeekRow.tsx"
      provides: "Single week row component"
    - path: "src/components/planner/DayCell.tsx"
      provides: "Individual day cell component"
    - path: "src/app/(tabs)/planner.tsx"
      provides: "Calendar FlatList with auto-scroll"
  key_links:
    - from: "src/app/(tabs)/planner.tsx"
      to: "src/hooks/useMealPlans.ts"
      via: "useMealPlans hook call"
      pattern: "useMealPlans\\(\\)"
    - from: "src/hooks/useMealPlans.ts"
      to: "convex/mealPlans.ts"
      via: "Convex API query"
      pattern: "api\\.mealPlans\\.listForDateRange"
    - from: "src/app/(tabs)/planner.tsx"
      to: "src/utils/dateUtils.ts"
      via: "date calculation imports"
      pattern: "get4WeekWindow|groupIntoWeeks"
---

<objective>
Build the 4-week calendar UI for the meal planner with date utilities, data hooks, and visual components.

Purpose: Display the rolling 4-week calendar (PLAN-01) with Monday-Sunday weeks (PLAN-03) showing assigned recipes.
Output: Working calendar UI that displays meal plans with proper date handling and auto-scroll to today.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-meal-planning/03-RESEARCH.md
@.planning/phases/03-meal-planning/03-CONTEXT.md
@.planning/phases/03-meal-planning/03-01-SUMMARY.md

@src/app/(tabs)/planner.tsx
@src/constants/theme.ts
@src/hooks/useRecipes.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Date Utilities</name>
  <files>src/utils/dateUtils.ts</files>
  <action>
Install date-fns and create date utility functions:

```bash
npm install date-fns --legacy-peer-deps
```

Create `src/utils/dateUtils.ts` with:

1. **get4WeekWindow()** - Returns array of 28 Date objects spanning 2 weeks ago through next week
   - Use startOfWeek with weekStartsOn: 1 for Monday start
   - subWeeks(thisWeekStart, 2) for window start
   - eachDayOfInterval for generating all days

2. **formatDateKey(date: Date)** - Returns YYYY-MM-DD string for Convex storage
   - Use date-fns format function

3. **parseDateKey(dateKey: string)** - Parses YYYY-MM-DD back to Date
   - Use date-fns parseISO function

4. **groupIntoWeeks(days: Date[])** - Groups 28 days into 4 WeekData objects
   - Each WeekData: { weekStart: Date, days: DayData[] }
   - Each DayData: { date: Date, dateKey: string, isToday: boolean, isPast: boolean }
   - Use isBefore(date, startOfDay(new Date())) for isPast
   - Use isToday() for today detection

5. **formatWeekRange(weekStart: Date)** - Returns "Jan 13 - Jan 19" format string
   - Handle month boundary (different format when week spans months)

6. **getWeekLabel(weekIndex: number)** - Returns human label for week position
   - 0: "2 weeks ago", 1: "Last week", 2: "This week", 3: "Next week"

Export TypeScript interfaces: WeekData, DayData.
  </action>
  <verify>Create a simple test in the file comments showing expected output for each function.</verify>
  <done>All date utilities compile and handle Monday-start weeks correctly.</done>
</task>

<task type="auto">
  <name>Task 2: Create Meal Plans Hook</name>
  <files>src/hooks/useMealPlans.ts</files>
  <action>
Create `src/hooks/useMealPlans.ts` following the pattern from useRecipes.ts:

1. **useMealPlans()** - Main data hook
   - Use useMemo to compute stable startDate/endDate from get4WeekWindow()
   - Call useQuery(api.mealPlans.listForDateRange, { householdId, startDate, endDate })
   - Return the query result (undefined while loading, then meal plan array)

2. **useSetMeal()** - Returns mutation function
   - useMutation(api.mealPlans.setMeal)

3. **useClearMeal()** - Returns mutation function
   - useMutation(api.mealPlans.clearMeal)

4. **useMealPlanMap()** - Convenience hook that returns Map<dateKey, MealPlan>
   - Uses useMealPlans() and transforms array to Map keyed by date string
   - Makes O(1) lookup by date easier in UI components

Import HOUSEHOLD_ID from constants/household.ts. Follow existing hook patterns for consistency.
  </action>
  <verify>TypeScript compiles without errors. Hook correctly re-exports Convex API types.</verify>
  <done>Four hooks exported: useMealPlans, useSetMeal, useClearMeal, useMealPlanMap.</done>
</task>

<task type="auto">
  <name>Task 3: Create Calendar Components and Update Planner Screen</name>
  <files>
    src/components/planner/DayCell.tsx
    src/components/planner/WeekRow.tsx
    src/app/(tabs)/planner.tsx
  </files>
  <action>
Create the planner components directory and files:

**DayCell.tsx** - Individual day in the calendar:
- Props: day (DayData), mealPlan (optional), onPress, onLongPress
- Display: Day number (e.g., "13"), day of week abbreviation (e.g., "Mon")
- If mealPlan exists: Show recipe title (truncated) and small thumbnail
- If no mealPlan and not past: Show "+" button
- If past: No "+" button, dimmed appearance (0.5 opacity)
- If isToday: Subtle highlight (primary color border or background tint)
- Disable onPress/onLongPress for past days
- Use theme colors and spacing from constants/theme.ts

**WeekRow.tsx** - Row of 7 days (Mon-Sun):
- Props: week (WeekData), mealPlanMap (Map), onDayPress, onDayLongPress
- Display: Week header with date range (formatWeekRange) and week label (getWeekLabel)
- Render 7 DayCell components horizontally
- Fixed height (WEEK_HEIGHT constant, ~140px including header)

**Update planner.tsx**:
- Replace placeholder content with FlatList of weeks
- Use get4WeekWindow() and groupIntoWeeks() to generate week data (memoized)
- Use useMealPlanMap() to get meal data
- Render WeekRow for each week
- Implement getItemLayout with fixed WEEK_HEIGHT for scrollToIndex
- Auto-scroll to THIS_WEEK_INDEX (2) on mount using ref and useEffect
- Use initialScrollIndex={2} as well
- Show loading state while mealPlans === undefined
- Add placeholder handlers for onDayPress and onDayLongPress (console.log for now)

Styling:
- Dark theme consistent with existing screens
- Past weeks visually dimmed (opacity)
- Today cell has subtle primary color indicator
- Recipe thumbnails are small squares (~40x40)
- Day cells evenly distributed across screen width
  </action>
  <verify>
App renders without crashes.
Calendar shows 4 weeks starting 2 weeks in the past.
Weeks show Mon-Sun (not Sun-Sat).
Auto-scrolls to "This week" on open.
Past days appear dimmed.
  </verify>
  <done>
Planner screen displays 4-week vertical calendar.
Weeks labeled correctly (2 weeks ago, Last week, This week, Next week).
Days show Mon-Sun format.
Today has visual highlight.
Past days are dimmed and non-interactive.
  </done>
</task>

</tasks>

<verification>
1. `npm run start` launches app without errors
2. Planner tab shows 4-week calendar
3. Weeks correctly start on Monday
4. "This week" is visible on initial load (auto-scroll worked)
5. Past days have dimmed appearance
6. Today has subtle highlight (border or background tint)
7. Tapping future/current days logs to console (handler connected)
</verification>

<success_criteria>
- 4-week calendar displays correctly (PLAN-01)
- Weeks run Monday through Sunday (PLAN-03)
- Calendar auto-scrolls to current week
- Past days visually distinct and non-interactive
- Today highlighted
- Meal plan data loads and displays when assigned
- Real-time sync works (both household members see same data - SYNC-01)
</success_criteria>

<output>
After completion, create `.planning/phases/03-meal-planning/03-02-SUMMARY.md`
</output>
