---
phase: 03-meal-planning
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - convex/schema.ts
  - convex/mealPlans.ts
autonomous: true

must_haves:
  truths:
    - "Meal plan entries can be created and stored in Convex"
    - "Meal plan entries can be queried by date range"
    - "Each date can have only one meal assignment"
  artifacts:
    - path: "convex/schema.ts"
      provides: "mealPlans table with recipeId field"
      contains: "recipeId: v.id('recipes')"
    - path: "convex/mealPlans.ts"
      provides: "CRUD mutations and queries for meal plans"
      exports: ["setMeal", "clearMeal", "listForDateRange"]
  key_links:
    - from: "convex/mealPlans.ts"
      to: "convex/schema.ts"
      via: "mealPlans table definition"
      pattern: "mealPlans"
---

<objective>
Create the Convex backend for meal planning: schema updates and mutations for assigning recipes to days.

Purpose: Establish the data layer that enables real-time meal plan sync between household members (SYNC-01).
Output: Working Convex mutations for setting, clearing, and querying meal plans.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-meal-planning/03-RESEARCH.md

@convex/schema.ts
@convex/recipes.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update Convex Schema</name>
  <files>convex/schema.ts</files>
  <action>
Update the mealPlans table to add the recipeId field:

```typescript
mealPlans: defineTable({
  householdId: v.id('households'),
  date: v.string(), // ISO date string (YYYY-MM-DD)
  recipeId: v.id('recipes'), // Recipe assigned to this day
}).index('by_household_date', ['householdId', 'date']),
```

The existing placeholder comment "// Additional fields added in Phase 3" should be replaced with the actual recipeId field.
  </action>
  <verify>Run `npx convex dev --once` to validate schema compiles without errors.</verify>
  <done>mealPlans table has recipeId field with correct type and index.</done>
</task>

<task type="auto">
  <name>Task 2: Create Meal Plan Mutations and Query</name>
  <files>convex/mealPlans.ts</files>
  <action>
Create a new file `convex/mealPlans.ts` with three functions:

1. **setMeal mutation** - Upsert pattern for assigning a recipe to a date:
   - Args: householdId, date (YYYY-MM-DD string), recipeId
   - Query existing meal plan by householdId + date using index
   - If exists: patch with new recipeId
   - If not exists: insert new record
   - Also update the recipe's lastUsed timestamp to current time

2. **clearMeal mutation** - Remove a meal assignment:
   - Args: householdId, date
   - Find and delete the meal plan entry for that date (if exists)

3. **listForDateRange query** - Fetch all meal plans in a date range:
   - Args: householdId, startDate, endDate (YYYY-MM-DD strings)
   - Query mealPlans where date >= startDate AND date <= endDate
   - For each meal plan, resolve the recipe details (get by recipeId)
   - For recipes with imageId, get the storage URL
   - Return array of meal plans with embedded recipe info (including imageUrl)

Use the index 'by_household_date' for efficient queries. Follow patterns from recipes.ts for consistency.
  </action>
  <verify>
Run `npx convex dev --once` to validate functions compile.
Check that the generated API includes mealPlans.setMeal, mealPlans.clearMeal, mealPlans.listForDateRange.
  </verify>
  <done>
Three functions exported: setMeal (upsert), clearMeal (delete), listForDateRange (query with recipe resolution).
lastUsed timestamp updated when assigning meals.
  </done>
</task>

</tasks>

<verification>
1. Schema validates: `npx convex dev --once` succeeds
2. API generated: `convex/_generated/api.d.ts` includes mealPlans module
3. Functions compile without TypeScript errors
</verification>

<success_criteria>
- mealPlans table schema includes recipeId field
- setMeal mutation creates or updates meal plan entries
- clearMeal mutation removes meal plan entries
- listForDateRange query returns meal plans with resolved recipe data
- All functions use proper Convex patterns (index queries, proper typing)
</success_criteria>

<output>
After completion, create `.planning/phases/03-meal-planning/03-01-SUMMARY.md`
</output>
