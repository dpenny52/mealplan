---
phase: 03-meal-planning
plan: 03
type: execute
wave: 3
depends_on: ["03-02"]
files_modified:
  - src/components/planner/RecipePickerModal.tsx
  - src/app/(tabs)/planner.tsx
autonomous: false

must_haves:
  truths:
    - "User can tap an empty day to open recipe picker"
    - "User can select a recipe from the picker to assign it"
    - "User can tap an assigned day to view the recipe detail"
    - "User can long-press an assigned day to change/clear the meal"
    - "Assigned recipes appear on the calendar immediately"
    - "Both household members see the same assignments in real-time"
  artifacts:
    - path: "src/components/planner/RecipePickerModal.tsx"
      provides: "Modal for selecting recipes to assign"
      min_lines: 80
    - path: "src/app/(tabs)/planner.tsx"
      provides: "Wired up day interactions"
      contains: "RecipePickerModal"
  key_links:
    - from: "src/app/(tabs)/planner.tsx"
      to: "src/components/planner/RecipePickerModal.tsx"
      via: "modal state and callbacks"
      pattern: "RecipePickerModal"
    - from: "src/components/planner/RecipePickerModal.tsx"
      to: "src/hooks/useRecipes.ts"
      via: "recipe list for selection"
      pattern: "useFilteredRecipes"
    - from: "src/app/(tabs)/planner.tsx"
      to: "src/hooks/useMealPlans.ts"
      via: "setMeal mutation call"
      pattern: "useSetMeal|useClearMeal"
---

<objective>
Complete the meal planning feature by adding the recipe picker modal and wiring up all day interactions.

Purpose: Enable users to assign recipes to days (PLAN-02), completing the core meal planning workflow.
Output: Fully functional meal planner where users can assign, view, and change recipe assignments.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-meal-planning/03-RESEARCH.md
@.planning/phases/03-meal-planning/03-CONTEXT.md
@.planning/phases/03-meal-planning/03-02-SUMMARY.md

@src/app/(tabs)/planner.tsx
@src/components/planner/DayCell.tsx
@src/components/recipe/RecipeSearch.tsx
@src/components/recipe/RecipeListItem.tsx
@src/hooks/useRecipes.ts
@src/hooks/useMealPlans.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Recipe Picker Modal</name>
  <files>src/components/planner/RecipePickerModal.tsx</files>
  <action>
Create `src/components/planner/RecipePickerModal.tsx`:

**Props interface:**
```typescript
interface RecipePickerModalProps {
  visible: boolean;
  selectedDate: string | null; // YYYY-MM-DD or null
  currentRecipeId?: string; // If editing existing meal
  onSelect: (recipeId: Id<'recipes'>) => void;
  onClear: () => void;
  onClose: () => void;
}
```

**Structure:**
1. Use React Native's built-in Modal with animationType="slide"
2. Full-screen modal with dark background matching app theme
3. Header with:
   - Close button (X icon) on left
   - Title showing the date being edited (e.g., "Mon, Jan 20")
   - If currentRecipeId exists, show "Clear" button on right
4. Search bar using existing RecipeSearch component
5. Recipe list using FlatList with RecipeListItem components
6. Loading state while recipes load

**Behavior:**
- Use useFilteredRecipes hook with search query state
- On recipe tap: call onSelect(recipeId) and close modal
- On Clear tap: call onClear() and close modal
- On backdrop tap or X: call onClose()
- Reset search query when modal closes

**Styling:**
- Match existing modal patterns (recipe create wizard uses similar structure)
- Dark theme colors from constants/theme.ts
- Safe area insets for header
  </action>
  <verify>
Component renders without errors.
Search filters recipe list.
Recipe items are tappable.
  </verify>
  <done>
RecipePickerModal renders full recipe list with search.
Clear button appears when editing existing meal.
All callbacks properly wired.
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire Up Day Interactions in Planner</name>
  <files>src/app/(tabs)/planner.tsx</files>
  <action>
Update planner.tsx to complete the interaction flow:

**State for modal:**
```typescript
const [pickerVisible, setPickerVisible] = useState(false);
const [selectedDate, setSelectedDate] = useState<string | null>(null);
const [editingMealId, setEditingMealId] = useState<string | undefined>();
```

**Get mutations:**
```typescript
const setMeal = useSetMeal();
const clearMeal = useClearMeal();
```

**Day press handlers:**

1. **handleDayPress(day: DayData, mealPlan?: MealPlan):**
   - If day.isPast: do nothing (read-only)
   - If mealPlan exists: navigate to recipe detail (router.push(`/recipe/${mealPlan.recipeId}`))
   - If no mealPlan: open picker for this date (setSelectedDate, setPickerVisible)

2. **handleDayLongPress(day: DayData, mealPlan?: MealPlan):**
   - If day.isPast: do nothing
   - If mealPlan exists: open picker in "edit mode" (set editingMealId)
   - If no mealPlan: open picker (same as tap)

3. **handleRecipeSelect(recipeId: Id<'recipes'>):**
   - Call setMeal({ householdId: HOUSEHOLD_ID, date: selectedDate, recipeId })
   - Close modal, reset state

4. **handleClearMeal():**
   - Call clearMeal({ householdId: HOUSEHOLD_ID, date: selectedDate })
   - Close modal, reset state

5. **handlePickerClose():**
   - Close modal, reset state (selectedDate, editingMealId)

**Pass handlers to WeekRow -> DayCell:**
- WeekRow receives onDayPress, onDayLongPress
- WeekRow passes to DayCell with the specific day and mealPlan

**Add RecipePickerModal to render:**
```tsx
<RecipePickerModal
  visible={pickerVisible}
  selectedDate={selectedDate}
  currentRecipeId={editingMealId}
  onSelect={handleRecipeSelect}
  onClear={handleClearMeal}
  onClose={handlePickerClose}
/>
```
  </action>
  <verify>
App compiles without errors.
Tapping empty day opens picker.
Selecting recipe assigns it and shows on calendar.
Tapping assigned day navigates to recipe detail.
Long-pressing assigned day opens picker with clear option.
  </verify>
  <done>
All day interactions work as specified in CONTEXT.md.
Recipe assignments are persisted via Convex.
Real-time sync verified (changes appear on both devices).
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Complete meal planning feature:
- 4-week rolling calendar (2 past + current + next week)
- Monday-Sunday week format
- Recipe assignment via tap -> picker -> select
- Recipe viewing via tap on assigned day
- Recipe replacement via long-press
- Clear meal option
- Real-time sync between devices
- Visual indicators for today and past days
  </what-built>
  <how-to-verify>
1. Open the app and go to the Planner tab
2. Verify you see 4 weeks: 2 weeks ago, last week, this week, and next week
3. Verify weeks run Monday (left) through Sunday (right)
4. Verify past days appear dimmed/faded
5. Verify today has a subtle highlight
6. Tap an empty day in the current or next week -> recipe picker should open
7. Search for a recipe and tap to select it
8. Verify the recipe appears on that day (title and/or thumbnail)
9. Tap the assigned day -> should navigate to recipe detail screen
10. Go back and long-press the same day -> picker opens with "Clear" option
11. Tap Clear -> meal is removed from that day
12. (Optional) If you have a second device: verify changes appear in real-time
  </how-to-verify>
  <resume-signal>Type "approved" if all 5 success criteria are met, or describe any issues found.</resume-signal>
</task>

</tasks>

<verification>
**Phase 3 Success Criteria:**
1. [x] User can view a 4-week calendar showing two weeks ago, last week, this week, and next week
2. [x] Weeks display Monday through Sunday (not Sunday through Saturday)
3. [x] User can assign any saved recipe to any day in the calendar
4. [x] User can see which recipes are planned for each day at a glance
5. [x] Both household members see the same meal plan in real-time

**Requirements Coverage:**
- PLAN-01: 4-week view - covered by calendar implementation
- PLAN-02: Assign recipes to days - covered by picker and mutations
- PLAN-03: Monday-Sunday weeks - covered by date-fns weekStartsOn: 1
</verification>

<success_criteria>
- Recipe picker modal opens on day tap/long-press
- Recipe selection assigns meal to the day
- Meal assignments appear immediately on calendar
- Tapping assigned day navigates to recipe detail
- Long-press allows changing or clearing meals
- Clear option removes meal assignment
- Real-time sync works between devices
- User verifies all 5 phase success criteria
</success_criteria>

<output>
After completion, create `.planning/phases/03-meal-planning/03-03-SUMMARY.md`
</output>
