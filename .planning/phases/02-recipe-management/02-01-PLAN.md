---
phase: 02-recipe-management
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - package.json
  - convex/schema.ts
  - convex/recipes.ts
  - convex/files.ts
  - babel.config.js
autonomous: true

must_haves:
  truths:
    - "Recipe schema deployed with all required fields"
    - "CRUD mutations available for recipes"
    - "File upload endpoint available for images"
  artifacts:
    - path: "convex/schema.ts"
      provides: "Full recipe table with indexes"
      contains: "ingredients: v.array"
    - path: "convex/recipes.ts"
      provides: "create, list, get, update, delete, updateSortOrder mutations/queries"
      exports: ["create", "list", "get", "update", "remove", "updateSortOrder"]
    - path: "convex/files.ts"
      provides: "generateUploadUrl mutation"
      exports: ["generateUploadUrl"]
  key_links:
    - from: "convex/recipes.ts"
      to: "convex/schema.ts"
      via: "schema type references"
      pattern: "ctx\\.db\\.(insert|query)\\('recipes'"
---

<objective>
Install Phase 2 dependencies and build complete recipe backend with Convex schema, CRUD operations, and file upload support.

Purpose: Establish the data foundation for recipe management. All UI work depends on these mutations/queries existing.
Output: Deployed Convex backend with recipe CRUD and file storage ready.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-recipe-management/02-RESEARCH.md

# Existing files to modify
@convex/schema.ts
@babel.config.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install Phase 2 dependencies</name>
  <files>package.json, babel.config.js</files>
  <action>
Install required dependencies for Phase 2:

```bash
npx expo install expo-image-picker react-native-reanimated react-native-gesture-handler @react-native-async-storage/async-storage
npm install --legacy-peer-deps react-native-draggable-flatlist vulgar-fractions
```

Update babel.config.js to add 'react-native-reanimated/plugin' as LAST plugin (required by Reanimated).

Note: Use --legacy-peer-deps for npm installs (React version conflict from 01-01).
  </action>
  <verify>
- npm ls expo-image-picker (shows installed)
- npm ls react-native-reanimated (shows installed)
- npm ls vulgar-fractions (shows installed)
- babel.config.js contains 'react-native-reanimated/plugin'
  </verify>
  <done>All Phase 2 dependencies installed and Babel configured for Reanimated</done>
</task>

<task type="auto">
  <name>Task 2: Update Convex schema with full recipe table</name>
  <files>convex/schema.ts</files>
  <action>
Replace the placeholder recipes table with full schema:

```typescript
recipes: defineTable({
  householdId: v.id('households'),
  title: v.string(),
  ingredients: v.array(v.string()),  // Free-form lines like "2 cups flour"
  instructions: v.optional(v.string()),
  prepTime: v.optional(v.number()),  // Minutes
  servings: v.optional(v.number()),
  imageId: v.optional(v.id('_storage')),  // Convex file storage
  sortOrder: v.number(),  // For custom ordering (RECIPE-06)
  lastUsed: v.optional(v.number()),  // Timestamp for "recently used" sort
  scaledServings: v.optional(v.number()),  // User's last scaled view preference
})
  .index('by_household', ['householdId'])
  .index('by_household_sort', ['householdId', 'sortOrder'])
  .index('by_household_lastUsed', ['householdId', 'lastUsed']),
```

Keep households, mealPlans, and groceryItems tables unchanged.
  </action>
  <verify>npx convex dev --once (deploys successfully with new schema)</verify>
  <done>Recipe schema has title, ingredients array, optional fields, and all three indexes</done>
</task>

<task type="auto">
  <name>Task 3: Create recipe CRUD mutations and queries</name>
  <files>convex/recipes.ts, convex/files.ts</files>
  <action>
Create convex/recipes.ts with these functions:

1. **create** mutation - accepts title, ingredients (required), optional fields; auto-sets sortOrder and lastUsed
2. **list** query - returns all recipes for household, ordered by lastUsed desc; resolves imageUrl from storage
3. **get** query - returns single recipe by ID with imageUrl
4. **update** mutation - updates any recipe fields
5. **remove** mutation - deletes recipe by ID
6. **updateSortOrder** mutation - accepts array of {_id, sortOrder} to bulk update order
7. **updateLastUsed** mutation - updates lastUsed timestamp when recipe is assigned to meal plan

Create convex/files.ts with:

1. **generateUploadUrl** mutation - returns presigned URL for image upload

Use patterns from 02-RESEARCH.md:
- Use v.optional() for optional args
- Resolve imageUrl via ctx.storage.getUrl() in list/get
- Return v.id('recipes') from create
- Include proper args validation with v.object()
  </action>
  <verify>
- npx convex dev --once (all functions deploy)
- TypeScript compiles: npx tsc --noEmit
  </verify>
  <done>All CRUD operations available: create, list, get, update, remove, updateSortOrder, updateLastUsed, generateUploadUrl</done>
</task>

</tasks>

<verification>
After all tasks:
1. `npx convex dev --once` shows successful deployment
2. `npx tsc --noEmit` passes
3. Convex dashboard shows recipes table with proper indexes
4. All mutations/queries visible in Convex dashboard functions tab
</verification>

<success_criteria>
- All Phase 2 npm packages installed
- Convex schema deployed with full recipe table
- Recipe CRUD mutations working (create, list, get, update, remove)
- Sort order update mutation working
- File upload URL generation working
- TypeScript compiles without errors
</success_criteria>

<output>
After completion, create `.planning/phases/02-recipe-management/02-01-SUMMARY.md`
</output>
