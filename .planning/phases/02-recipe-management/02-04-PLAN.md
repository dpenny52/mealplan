---
phase: 02-recipe-management
plan: 04
type: execute
wave: 3
depends_on: ["02-02", "02-03"]
files_modified:
  - src/app/recipe/[id].tsx
  - src/components/recipe/ServingStepper.tsx
  - src/components/recipe/IngredientList.tsx
  - src/hooks/useServingScale.ts
  - src/utils/fractions.ts
autonomous: true

must_haves:
  truths:
    - "User can tap a recipe to see full details"
    - "User can adjust serving size with +/- stepper"
    - "Ingredient quantities scale proportionally when servings change"
    - "Scaled quantities display as fractions (1/2, 1/4) not decimals"
  artifacts:
    - path: "src/app/recipe/[id].tsx"
      provides: "Recipe detail screen with scaling"
      min_lines: 120
    - path: "src/components/recipe/ServingStepper.tsx"
      provides: "Stepper control for serving adjustment"
      min_lines: 40
    - path: "src/components/recipe/IngredientList.tsx"
      provides: "Scaled ingredient display"
      min_lines: 50
    - path: "src/hooks/useServingScale.ts"
      provides: "Scaling calculations and persistence"
      exports: ["useServingScale"]
    - path: "src/utils/fractions.ts"
      provides: "Quantity parsing and fraction display"
      exports: ["parseQuantity", "scaleQuantity", "formatQuantity"]
  key_links:
    - from: "src/app/recipe/[id].tsx"
      to: "convex/recipes.ts"
      via: "useQuery"
      pattern: "useQuery.*api\\.recipes\\.get"
    - from: "src/hooks/useServingScale.ts"
      to: "src/utils/fractions.ts"
      via: "scaleQuantity function"
      pattern: "scaleQuantity"
---

<objective>
Build the recipe detail screen with serving size adjustment and ingredient scaling using vulgar fractions.

Purpose: Users need to view full recipe details (RECIPE-02) and scale portions (RECIPE-05). Proper fraction display makes scaled quantities usable.
Output: Detail screen showing recipe with interactive serving scaling.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/02-recipe-management/02-CONTEXT.md
@.planning/phases/02-recipe-management/02-RESEARCH.md
@.planning/phases/02-recipe-management/02-01-SUMMARY.md

# Existing files
@src/constants/theme.ts
@src/constants/household.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create fraction utilities for ingredient scaling</name>
  <files>src/utils/fractions.ts</files>
  <action>
Create src/utils/ directory and fractions.ts with:

**parseQuantity(ingredientLine: string)**
- Extract leading number from free-form text (e.g., "2 cups flour" -> 2)
- Handle fractions in input (1/2 -> 0.5, "1 1/2" -> 1.5)
- Return { quantity: number | null, rest: string }
- null quantity if no number found ("pinch of salt")

**scaleQuantity(quantity: number, scaleFactor: number)**
- Multiply quantity by scale factor
- Round to nearest 1/8 to avoid awkward fractions (per RESEARCH.md pitfall)
- Return scaled number

**formatQuantity(quantity: number)**
- Use vulgar-fractions library (toVulgar function)
- Handle whole + fraction (1.5 -> "1 1/2")
- Return string with proper Unicode fractions

Example flow:
- Input: "2 cups flour", original servings: 4, new servings: 6
- Scale factor: 6/4 = 1.5
- parseQuantity -> { quantity: 2, rest: "cups flour" }
- scaleQuantity(2, 1.5) -> 3
- formatQuantity(3) -> "3"
- Output: "3 cups flour"
  </action>
  <verify>
- npx tsc --noEmit
- Manual test in code: formatQuantity(0.5) returns "1/2" or similar
  </verify>
  <done>Fraction utilities parse, scale, and format ingredient quantities with vulgar fractions</done>
</task>

<task type="auto">
  <name>Task 2: Create scaling hook and display components</name>
  <files>src/hooks/useServingScale.ts, src/components/recipe/ServingStepper.tsx, src/components/recipe/IngredientList.tsx</files>
  <action>
**useServingScale hook (src/hooks/useServingScale.ts):**
- Input: recipeId, originalServings (from recipe)
- State: currentServings (starts at recipe.scaledServings or originalServings)
- Computed: scaleFactor = currentServings / originalServings
- setServings function to update state
- On servings change, call updateScaledServings mutation (persists to Convex)
- scaleIngredients function using fractions.ts utilities

**ServingStepper component (src/components/recipe/ServingStepper.tsx):**
- Props: value, onDecrement, onIncrement, min (default 1), max (default 99)
- "-" button | current value display | "+" button
- Disable "-" at min, "+" at max
- Dark theme styling (Colors.surface background, Colors.primary for buttons)

**IngredientList component (src/components/recipe/IngredientList.tsx):**
- Props: ingredients (string[]), scaleFactor (number)
- Maps ingredients through scaleQuantity flow
- Displays each scaled ingredient in list
- Handles non-numeric ingredients gracefully (pass through unchanged)
  </action>
  <verify>npx tsc --noEmit</verify>
  <done>Scaling hook and components ready for detail screen integration</done>
</task>

<task type="auto">
  <name>Task 3: Build recipe detail screen</name>
  <files>src/app/recipe/[id].tsx</files>
  <action>
Create src/app/recipe/[id].tsx for dynamic recipe detail:

**Layout:**
- Hero image at top (or placeholder if no image)
- Recipe title (large, Colors.text)
- Metadata row: prep time, original servings
- ServingStepper for adjusting servings
- Divider
- "Ingredients" section header
- IngredientList with scaled ingredients
- Divider
- "Instructions" section header
- Instructions text (if exists)

**Data:**
- useLocalSearchParams() to get id
- useQuery(api.recipes.get, { id }) to fetch recipe
- useServingScale hook for scaling logic
- Loading state while recipe loads
- Error state if recipe not found

**Navigation:**
- Back button in header (or use default Stack back)
- Edit button (future - can be placeholder for now)

Style with dark theme. ScrollView for long content.
  </action>
  <verify>
- npx tsc --noEmit
- Tap recipe from list -> shows detail screen
- Serving stepper increments/decrements
- Ingredient quantities update when servings change
- Scaled quantities show fractions (1/2, 1/4) not decimals
  </verify>
  <done>Recipe detail screen shows full recipe with interactive serving scaling</done>
</task>

</tasks>

<verification>
After all tasks:
1. `npx tsc --noEmit` passes
2. Navigate from recipe list to detail screen
3. Detail shows all recipe data (title, ingredients, instructions, image)
4. ServingStepper appears if recipe has servings
5. Changing servings updates ingredient quantities in real-time
6. Scaled quantities use fractions (1/2, 3/4) not decimals (0.5, 0.75)
7. Scaled serving preference persists (refresh shows same scaled value)
</verification>

<success_criteria>
- Recipe detail screen shows all stored recipe data
- Serving stepper allows +/- adjustment
- Ingredient quantities scale proportionally
- Scaled quantities display as vulgar fractions
- Non-numeric ingredients pass through unchanged ("pinch of salt")
- Scaled serving preference persists to Convex
- Clean dark theme presentation matching app style
</success_criteria>

<output>
After completion, create `.planning/phases/02-recipe-management/02-04-SUMMARY.md`
</output>
