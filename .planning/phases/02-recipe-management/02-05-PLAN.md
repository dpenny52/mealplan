---
phase: 02-recipe-management
plan: 05
type: execute
wave: 4
depends_on: ["02-02", "02-04"]
files_modified:
  - src/app/(tabs)/recipes.tsx
  - src/components/recipe/RecipeCard.tsx
  - src/components/recipe/RecipeListItem.tsx
autonomous: false

must_haves:
  truths:
    - "User can long-press and drag to reorder recipes"
    - "New sort order persists after app restart"
    - "Reordering works in list view mode"
  artifacts:
    - path: "src/app/(tabs)/recipes.tsx"
      provides: "Recipe list with drag reorder functionality"
      contains: "DraggableFlatList"
  key_links:
    - from: "src/app/(tabs)/recipes.tsx"
      to: "convex/recipes.ts"
      via: "updateSortOrder mutation"
      pattern: "useMutation.*api\\.recipes\\.updateSortOrder"
---

<objective>
Add drag-to-reorder functionality for custom recipe ordering and verify the complete recipe management feature.

Purpose: Users want to organize their recipes in a personal order (RECIPE-06). This completes the Phase 2 requirements.
Output: Reorderable recipe list and verified recipe management feature.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/02-recipe-management/02-CONTEXT.md
@.planning/phases/02-recipe-management/02-RESEARCH.md
@.planning/phases/02-recipe-management/02-02-SUMMARY.md
@.planning/phases/02-recipe-management/02-04-SUMMARY.md

# Files to modify
@src/app/(tabs)/recipes.tsx
@src/components/recipe/RecipeCard.tsx
@src/components/recipe/RecipeListItem.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement drag-to-reorder with DraggableFlatList</name>
  <files>src/app/(tabs)/recipes.tsx, src/components/recipe/RecipeCard.tsx, src/components/recipe/RecipeListItem.tsx</files>
  <action>
Update recipes.tsx to use react-native-draggable-flatlist:

1. Import DraggableFlatList and ScaleDecorator from 'react-native-draggable-flatlist'
2. Replace FlatList with DraggableFlatList for list mode (reordering works in list view)
3. Keep regular FlatList for card mode (grid reordering is complex, not required)

**renderItem pattern (from RESEARCH.md):**
```typescript
const renderItem = ({ item, drag, isActive }) => (
  <ScaleDecorator>
    <RecipeListItem
      recipe={item}
      onPress={() => router.push(`/recipe/${item._id}`)}
      onLongPress={drag}
      isActive={isActive}
    />
  </ScaleDecorator>
);
```

Update RecipeListItem and RecipeCard to accept:
- onLongPress?: () => void
- isActive?: boolean (for visual feedback during drag)

When isActive, apply subtle visual feedback (slight scale, different background).

**onDragEnd handler:**
```typescript
const onDragEnd = ({ data }) => {
  // Update local state immediately for responsive UI
  // Then call mutation to persist
  const updates = data.map((recipe, index) => ({
    _id: recipe._id,
    sortOrder: index,
  }));
  updateSortOrder({ updates });
};
```

Add toggle or mode indicator showing user can long-press to reorder in list mode.
  </action>
  <verify>
- npx tsc --noEmit
- In list mode, long-press shows drag feedback
- Drag and drop reorders the list
- Order persists after app refresh
  </verify>
  <done>Drag-to-reorder implemented for recipe list with persistence</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Complete recipe management feature:
- Create recipes with multi-step wizard (title, ingredients, optional details)
- View recipes in card or list mode
- Search recipes by title or ingredient
- View recipe details with serving scaling
- Drag-to-reorder in list mode
  </what-built>
  <how-to-verify>
1. Start app: `npx expo start --android`
2. Open Recipes tab

**Test Recipe Creation (RECIPE-01):**
3. Tap add recipe button/FAB
4. Enter title "Test Recipe"
5. Tap Next
6. Add ingredients: "2 cups flour", "1/2 cup sugar", "pinch of salt"
7. Tap Next
8. Optionally add prep time (30), servings (4), instructions
9. Tap Save
10. Verify recipe appears in list

**Test Recipe List & Search (RECIPE-02, RECIPE-03):**
11. Verify recipe shows in list
12. Toggle to card view, verify recipe shows as card
13. Type "flour" in search - recipe should appear
14. Type "xyz" in search - recipe should disappear (no match)
15. Clear search - recipe reappears

**Test Recipe Detail & Scaling (RECIPE-05):**
16. Tap recipe to open detail
17. Verify all data displays (title, ingredients, instructions, prep time)
18. If servings set, tap + to increase servings
19. Verify "2 cups flour" becomes "3 cups flour" (at 6 servings)
20. Verify "1/2 cup sugar" becomes "3/4 cup sugar" (fraction display)
21. Navigate back

**Test Reordering (RECIPE-06):**
22. Create a second recipe
23. Switch to list view
24. Long-press first recipe, drag below second
25. Release - order should update
26. Force close and reopen app
27. Verify new order persisted
  </how-to-verify>
  <resume-signal>Type "approved" if all features work, or describe any issues found</resume-signal>
</task>

</tasks>

<verification>
After all tasks:
1. `npx tsc --noEmit` passes
2. All RECIPE requirements verified:
   - RECIPE-01: Create recipe with wizard (title, ingredients, optional fields)
   - RECIPE-02: View recipe collection (list and card views)
   - RECIPE-03: Search by name or ingredient
   - RECIPE-05: Scale servings with fraction display
   - RECIPE-06: Drag to reorder (persists)
</verification>

<success_criteria>
Phase 2 Complete when:
- User can create recipes via multi-step wizard
- User can view recipes in card or list mode
- User can search recipes by title or ingredient
- User can tap recipe to see full details
- User can adjust servings and see scaled quantities as fractions
- User can drag-to-reorder recipes in list mode
- All data persists in Convex (survives app restart)
- Human verification approved
</success_criteria>

<output>
After completion, create `.planning/phases/02-recipe-management/02-05-SUMMARY.md`
</output>
