---
phase: 04-grocery-lists
plan: 02
type: execute
wave: 2
depends_on: ["04-01"]
files_modified:
  - src/hooks/useGroceryList.ts
  - src/components/grocery/GroceryItem.tsx
  - src/components/grocery/ManualItemInput.tsx
  - src/components/grocery/GroceryHeader.tsx
  - src/app/(tabs)/grocery.tsx
autonomous: false

must_haves:
  truths:
    - "User can generate a grocery list from next week's meals with one tap"
    - "User can see all ingredients needed from assigned recipes"
    - "User can check off items while shopping"
    - "Checked items stay in place with strikethrough"
    - "User can export/share the grocery list via native share sheet"
    - "User can add manual items that persist across regeneration"
    - "User can uncheck all items with one tap"
  artifacts:
    - path: "src/hooks/useGroceryList.ts"
      provides: "Hook for grocery queries and mutations"
      exports: ["useGroceryList", "useGenerateGroceryList", "useToggleItem", "useAddManualItem", "useUncheckAll"]
    - path: "src/components/grocery/GroceryItem.tsx"
      provides: "Single grocery item with checkbox"
      exports: ["GroceryItem"]
    - path: "src/components/grocery/ManualItemInput.tsx"
      provides: "Input for adding manual items"
      exports: ["ManualItemInput"]
    - path: "src/components/grocery/GroceryHeader.tsx"
      provides: "Header with generate and share buttons"
      exports: ["GroceryHeader"]
    - path: "src/app/(tabs)/grocery.tsx"
      provides: "Complete grocery list screen"
      min_lines: 80
  key_links:
    - from: "src/app/(tabs)/grocery.tsx"
      to: "src/hooks/useGroceryList.ts"
      via: "useGroceryList hook"
      pattern: "useGroceryList"
    - from: "src/hooks/useGroceryList.ts"
      to: "convex/groceryLists.ts"
      via: "Convex queries and mutations"
      pattern: "api\\.groceryLists"
    - from: "src/components/grocery/GroceryHeader.tsx"
      to: "react-native Share"
      via: "Share.share() call"
      pattern: "Share\\.share"
---

<objective>
Build the grocery list UI with generation from meal plan, checkbox interaction, manual item entry, and share functionality.

Purpose: Complete the user-facing grocery list feature satisfying GROC-01, GROC-03, GROC-04 requirements.

Output: Fully functional grocery list screen where users can generate lists from next week's meals, check off items while shopping, add manual items, and share the list.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-grocery-lists/04-CONTEXT.md
@.planning/phases/04-grocery-lists/04-RESEARCH.md
@.planning/phases/04-grocery-lists/04-01-SUMMARY.md

# Reference existing code patterns
@src/hooks/useMealPlans.ts
@src/hooks/useRecipes.ts
@src/components/planner/WeekRow.tsx
@src/app/(tabs)/grocery.tsx
@src/utils/dateUtils.ts
@src/constants/theme.ts
@src/constants/household.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install expo-checkbox and create grocery hook</name>
  <files>src/hooks/useGroceryList.ts</files>
  <action>
1. **Install expo-checkbox:**
   ```bash
   npx expo install expo-checkbox
   ```

2. **Create src/hooks/useGroceryList.ts** following the pattern from useMealPlans.ts:
   - `useGroceryList()` - Query all grocery items using api.groceryLists.list
   - `useGenerateGroceryList()` - Mutation wrapper for api.groceryLists.generate
   - `useToggleItem()` - Mutation wrapper for api.groceryLists.toggleItem
   - `useAddManualItem()` - Mutation wrapper for api.groceryLists.addManualItem
   - `useUncheckAll()` - Mutation wrapper for api.groceryLists.uncheckAll
   - `useDeleteItem()` - Mutation wrapper for api.groceryLists.deleteItem
   - `useClearGenerated()` - Mutation wrapper for api.groceryLists.clearGenerated

   Helper function:
   - `getNextWeekStart(): string` - Returns YYYY-MM-DD of next Monday using date-fns:
     ```typescript
     const today = new Date();
     const thisMonday = startOfWeek(today, { weekStartsOn: 1 });
     const nextMonday = addWeeks(thisMonday, 1);
     return format(nextMonday, 'yyyy-MM-dd');
     ```

   Export type for grocery item:
   ```typescript
   export type GroceryItem = NonNullable<ReturnType<typeof useGroceryList>>[number];
   ```
  </action>
  <verify>
    - `npx tsc --noEmit` passes
    - expo-checkbox appears in package.json dependencies
  </verify>
  <done>
    - expo-checkbox installed
    - useGroceryList.ts exports all hook functions
    - getNextWeekStart correctly computes next Monday's date
  </done>
</task>

<task type="auto">
  <name>Task 2: Create grocery components</name>
  <files>src/components/grocery/GroceryItem.tsx, src/components/grocery/ManualItemInput.tsx, src/components/grocery/GroceryHeader.tsx</files>
  <action>
1. **Create src/components/grocery/GroceryItem.tsx:**
   - Props: item (GroceryItem), onToggle (itemId: string) => void
   - Layout: Checkbox on left, displayText on right
   - Use expo-checkbox with onValueChange calling onToggle
   - When checked: strikethrough text, reduced opacity (0.5)
   - Styles: Row layout, padding 12, borderBottom for separation
   - Colors from theme.ts (Colors.text, Colors.primary for checkbox)

2. **Create src/components/grocery/ManualItemInput.tsx:**
   - Props: onAdd (name: string) => void
   - Layout: TextInput with "Add item..." placeholder, plus button
   - State: local text input value
   - On submit (button press or keyboard return): call onAdd, clear input
   - Show input always visible at bottom of list
   - Styles: Row layout, TextInput flex: 1, plus icon button

3. **Create src/components/grocery/GroceryHeader.tsx:**
   - Props: onGenerate () => void, onShare () => void, onUncheckAll () => void, dateRange: string, hasItems: boolean
   - Layout: Title "Grocery List", subtitle with date range, row of action buttons
   - Buttons: "Generate" (primary), "Share" (secondary), "Uncheck All" (tertiary, only if hasItems)
   - Generate button shows "Generating..." while loading (use isGenerating prop or local state)
   - Share button opens native share sheet
   - Styles: Use existing button patterns, Colors.primary for generate button
  </action>
  <verify>
    - `npx tsc --noEmit` passes
    - Components export correctly
  </verify>
  <done>
    - GroceryItem.tsx renders checkbox with strikethrough when checked
    - ManualItemInput.tsx has working text input and add button
    - GroceryHeader.tsx has generate, share, and uncheck all buttons
  </done>
</task>

<task type="auto">
  <name>Task 3: Wire up grocery screen with share functionality</name>
  <files>src/app/(tabs)/grocery.tsx</files>
  <action>
Rewrite src/app/(tabs)/grocery.tsx to be fully functional:

1. **Imports:**
   - Share from 'react-native'
   - All hooks from useGroceryList.ts
   - All components from components/grocery/
   - FlatList for item list
   - startOfWeek, addWeeks, format from date-fns

2. **Data fetching:**
   - Use useGroceryList() for items
   - Use all mutation hooks

3. **Share function:**
   ```typescript
   const handleShare = async () => {
     if (!items?.length) return;

     // Compute date range for header
     const nextMonday = startOfWeek(addWeeks(new Date(), 1), { weekStartsOn: 1 });
     const nextSunday = new Date(nextMonday);
     nextSunday.setDate(nextSunday.getDate() + 6);
     const dateRange = `${format(nextMonday, 'MMM d')}-${format(nextSunday, 'd')}`;

     const header = `Grocery List (${dateRange})`;
     const lines = items.map(item => `[ ] ${item.displayText}`);
     const message = [header, '', ...lines].join('\n');

     try {
       await Share.share({ message, title: header });
     } catch (error) {
       console.error('Share failed:', error);
     }
   };
   ```

4. **Generate handler:**
   ```typescript
   const [isGenerating, setIsGenerating] = useState(false);

   const handleGenerate = async () => {
     setIsGenerating(true);
     try {
       const weekStart = getNextWeekStart();
       await generateList({ weekStart });
     } finally {
       setIsGenerating(false);
     }
   };
   ```

5. **Layout:**
   - GroceryHeader at top (sticky)
   - FlatList for items (generated items first section, then manual items section)
   - ManualItemInput at bottom (outside FlatList, always visible)
   - Empty state when no items: "No items on your list" with subtext "Generate a list from your meal plan"

6. **Sections:**
   - SectionList or FlatList with section headers
   - "From Meal Plan" section for isGenerated: true items
   - "Other Items" section for isGenerated: false items
   - Only show section if it has items

7. **Styling:**
   - Follow existing dark mode patterns (Colors.background, Colors.surface, Colors.text)
   - Safe area insets for header
   - Consistent padding with Spacing constants
  </action>
  <verify>
    - `npx tsc --noEmit` passes
    - `npx expo start` launches without errors
    - Navigate to Grocery tab, see empty state
    - Tap Generate, see loading state, then items appear
    - Tap checkbox, item gets strikethrough
    - Add manual item, it appears in "Other Items" section
    - Tap Share, native share sheet opens with formatted list
  </verify>
  <done>
    - Grocery screen displays generated and manual items in sections
    - Generate button creates list from next week's meal plan
    - Checkboxes toggle with strikethrough visual
    - Share exports formatted text list
    - Manual items persist across regeneration
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Complete grocery list feature with generation, check-off, manual items, and share</what-built>
  <how-to-verify>
    1. Open the app and navigate to the **Grocery** tab
    2. Verify empty state shows "No items on your list"
    3. Tap **Generate** button
       - Button should show loading state
       - List should populate with ingredients from next week's planned meals
    4. Verify items are grouped: "From Meal Plan" section first, then "Other Items" (if any)
    5. **Tap a checkbox** (not the row, just the checkbox)
       - Item should get strikethrough and reduced opacity
       - State should persist (refresh app to verify)
    6. Open on second device (or simulator)
       - Verify checked state syncs in real-time
    7. **Add a manual item** using the input at bottom
       - Type "Paper towels" and tap add/submit
       - Item should appear in "Other Items" section
    8. **Regenerate** the list
       - Tap Generate again
       - "From Meal Plan" items should refresh
       - "Paper towels" should still be there (manual items preserved)
    9. Tap **Share** button
       - Native share sheet should open
       - Preview should show formatted list like:
         ```
         Grocery List (Jan 27-Feb 2)

         [ ] Flour (3 cups)
         [ ] Butter (1/2 lb)
         ...
         ```
    10. Tap **Uncheck All** (if visible)
        - All checkmarks should clear
  </how-to-verify>
  <resume-signal>Type "approved" if all checks pass, or describe any issues</resume-signal>
</task>

</tasks>

<verification>
After all tasks complete:
1. `npx tsc --noEmit` - no TypeScript errors
2. `npx expo start` - app launches
3. Navigate to Grocery tab
4. Generate list from meal plan - items appear
5. Check off items - visual feedback correct
6. Add manual item - appears in correct section
7. Regenerate - manual items preserved
8. Share - native sheet opens with formatted text
9. Test on two devices - real-time sync works
</verification>

<success_criteria>
- [ ] User can generate grocery list from next week's meals with one tap (GROC-01)
- [ ] Grocery list shows all ingredients from assigned recipes (GROC-01)
- [ ] User can check off items while shopping with real-time sync (GROC-03)
- [ ] User can export/share via native share sheet (GROC-04)
- [ ] Manual items persist across regeneration
- [ ] Checked items show strikethrough, stay in place
- [ ] Empty state displays when no items
</success_criteria>

<output>
After completion, create `.planning/phases/04-grocery-lists/04-02-SUMMARY.md`
</output>
