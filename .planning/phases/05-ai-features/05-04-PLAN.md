---
phase: 05-ai-features
plan: 04
type: execute
wave: 3
depends_on: ["05-02", "05-03"]
files_modified:
  - src/app/(tabs)/recipes.tsx
  - src/app/recipe/create/index.tsx
  - src/app/recipe/create/ingredients.tsx
autonomous: false

must_haves:
  truths:
    - "User can access camera scan from recipe list (FAB or button)"
    - "Low-confidence fields are visually highlighted in review"
    - "User can view original photo during review"
    - "Complete extraction flow works end-to-end"
    - "AI ingredient aggregation improves grocery list quality"
  artifacts:
    - path: "src/app/(tabs)/recipes.tsx"
      provides: "Scan entry point"
      contains: "recipe/scan"
    - path: "src/app/recipe/create/index.tsx"
      provides: "Confidence highlighting"
      contains: "extractionConfidence"
  key_links:
    - from: "src/app/(tabs)/recipes.tsx"
      to: "/recipe/scan"
      via: "router.push('/recipe/scan')"
      pattern: "recipe/scan"
---

<objective>
Integrate AI features and verify complete flow

Purpose: Add entry points to access the camera scan feature, implement confidence highlighting in the review wizard, and verify the complete AI feature set works end-to-end.

Output: Fully integrated AI features with FAB entry point, confidence highlighting, and user-verified functionality.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-ai-features/05-CONTEXT.md
@.planning/phases/05-ai-features/05-RESEARCH.md
@.planning/phases/05-ai-features/05-01-SUMMARY.md
@.planning/phases/05-ai-features/05-02-SUMMARY.md
@.planning/phases/05-ai-features/05-03-SUMMARY.md

# Files to modify
@src/app/(tabs)/recipes.tsx
@src/app/recipe/create/index.tsx
@src/app/recipe/create/ingredients.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add scan entry point to recipe list</name>
  <files>src/app/(tabs)/recipes.tsx</files>
  <action>
Add a camera/scan button to the recipe list screen header, next to the existing add button.

Per CONTEXT.md: "Entry points: FAB on recipe list screen + option in add recipe flow"

Changes to recipes.tsx:
1. Add camera icon button in headerActions (next to the + button)
2. On press, navigate to /recipe/scan

```typescript
// Add to headerActions, before the existing add button:
<TouchableOpacity onPress={handleScanPress} style={styles.headerButton}>
  <Ionicons name="camera" size={24} color={Colors.primary} />
</TouchableOpacity>

// Add handler:
const handleScanPress = useCallback(() => {
  router.push('/recipe/scan');
}, [router]);
```

This places the scan option prominently in the header, making photo extraction easily discoverable.
  </action>
  <verify>
Camera icon visible in recipe list header. Tapping navigates to camera screen.
  </verify>
  <done>Users can access recipe scan from the recipe list screen</done>
</task>

<task type="auto">
  <name>Task 2: Add confidence highlighting to wizard</name>
  <files>src/app/recipe/create/index.tsx, src/app/recipe/create/ingredients.tsx</files>
  <action>
Add visual highlighting for low-confidence fields when displaying extracted recipe data.

Per CONTEXT.md: "Highlight low-confidence fields with yellow/orange border"
Per RESEARCH.md: "Start with 0.7 [threshold], allow Claude's discretion"

**In src/app/recipe/create/index.tsx (title/basic info step):**

1. Import extractionConfidence from useWizard
2. Add conditional styling for title input when titleConfidence < 0.7:
```typescript
const { data } = useWizard();
const isLowConfidenceTitle = data.extractionConfidence?.titleConfidence !== undefined
  && data.extractionConfidence.titleConfidence < 0.7;

// In TextInput for title:
style={[styles.input, isLowConfidenceTitle && styles.lowConfidenceInput]}
```

3. Add lowConfidenceInput style:
```typescript
lowConfidenceInput: {
  borderColor: '#FFA500', // Orange
  borderWidth: 2,
},
```

4. Optionally add a small info icon or text hint explaining the highlight

**In src/app/recipe/create/ingredients.tsx:**

1. Check each ingredient's confidence from extractionConfidence.ingredients array
2. Highlight ingredients with confidence < 0.7
3. Match by index (extraction order matches wizard ingredients order)

```typescript
const { data } = useWizard();

// In ingredient item rendering:
const ingredientConfidence = data.extractionConfidence?.ingredients?.[index]?.confidence;
const isLowConfidence = ingredientConfidence !== undefined && ingredientConfidence < 0.7;
```

**Add "View Original" button (if originalPhotoUri exists):**

In the first wizard step (index.tsx), add a button to view the original photo:
```typescript
{data.originalPhotoUri && (
  <TouchableOpacity onPress={() => /* show image modal */}>
    <Text style={styles.viewOriginalText}>View original photo</Text>
  </TouchableOpacity>
)}
```

Use a simple Image modal or navigate to a full-screen image viewer.
  </action>
  <verify>
1. Extract a recipe with some unclear text (e.g., blurry photo)
2. Low-confidence fields show orange border
3. "View original" button appears when extraction data present
  </verify>
  <done>Low-confidence fields are visually highlighted, users can review and correct extracted data</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 3: End-to-end AI feature verification</name>
  <what-built>
Complete AI features for Phase 5:
1. Recipe photo extraction via Gemini AI
2. Camera capture with frame overlay
3. Pre-populated wizard with confidence highlighting
4. AI-powered ingredient aggregation for grocery lists
  </what-built>
  <how-to-verify>
**Setup (one-time):**
1. Get Gemini API key from Google AI Studio: https://aistudio.google.com/apikey
2. Add to Convex: Dashboard -> Settings -> Environment Variables -> Add GEMINI_API_KEY

**Test Recipe Extraction (RECIPE-04):**
1. Open the app and go to Recipes tab
2. Tap the camera icon in the header
3. Grant camera permission when prompted
4. Point camera at a printed or displayed recipe (cookbook, magazine, phone screen)
5. Tap capture button
6. Observe "Extracting recipe..." spinner (should complete within 15 seconds)
7. Should navigate to recipe wizard with:
   - Title pre-filled
   - Ingredients pre-filled
   - Low-confidence fields highlighted in orange (if any)
8. Verify "View original" button shows the captured photo
9. Edit any incorrect fields and save the recipe
10. Verify recipe appears in list

**Test Gallery Option:**
1. From camera screen, tap "Gallery" button
2. Select a photo of a recipe
3. Same extraction flow should work

**Test AI Grocery Aggregation (GROC-02):**
1. Create two recipes with similar ingredients:
   - Recipe A: "2 chicken breasts", "1 cup rice"
   - Recipe B: "boneless chicken breast", "2 cups rice"
2. Assign both recipes to days next week
3. Go to Grocery tab and tap Generate
4. Verify:
   - Chicken items are combined (should show ~3 chicken breast total)
   - Rice is combined (should show 3 cups rice)

**Error Handling:**
1. Try extraction with a non-recipe image (e.g., blank wall)
2. Should show error message, not crash
3. Retry button should work
  </how-to-verify>
  <resume-signal>
Type "approved" if all 4 success criteria pass:
1. Photo extraction works (take photo -> get recipe data)
2. Review/edit flow works (low-confidence highlighting, view original)
3. Recipe saves correctly after extraction
4. AI aggregation combines similar ingredients

Or describe any issues found.
  </resume-signal>
</task>

</tasks>

<verification>
All Phase 5 success criteria from ROADMAP.md:
1. User can take a photo of a recipe (from a book, magazine, or printout) - VERIFIED
2. App extracts recipe details from the photo via Gemini AI - VERIFIED
3. User can review and edit extracted recipe before saving (mandatory confirmation) - VERIFIED
4. When generating grocery lists, similar ingredients are intelligently combined - VERIFIED
</verification>

<success_criteria>
- Camera icon visible on recipe list screen
- Photo capture and extraction works
- Low-confidence fields highlighted in orange
- View original photo option available
- Recipe saves correctly after review
- AI grocery aggregation combines similar ingredients
- Fallback works when AI unavailable
- User approval obtained
</success_criteria>

<output>
After completion, create `.planning/phases/05-ai-features/05-04-SUMMARY.md`
</output>
