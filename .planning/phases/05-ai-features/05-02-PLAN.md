---
phase: 05-ai-features
plan: 02
type: execute
wave: 2
depends_on: ["05-01"]
files_modified:
  - src/app/recipe/scan/_layout.tsx
  - src/app/recipe/scan/index.tsx
  - src/components/recipe/RecipeFrameOverlay.tsx
  - app.json (camera permission)
autonomous: true

must_haves:
  truths:
    - "User can open camera from recipe screen"
    - "Camera shows recipe frame overlay"
    - "Captured photo is sent to Gemini for extraction"
    - "Extracted data populates the recipe wizard"
    - "15-second timeout shows friendly error"
  artifacts:
    - path: "src/app/recipe/scan/index.tsx"
      provides: "Camera capture screen"
      min_lines: 100
    - path: "src/components/recipe/RecipeFrameOverlay.tsx"
      provides: "Recipe frame guide overlay"
      min_lines: 20
  key_links:
    - from: "src/app/recipe/scan/index.tsx"
      to: "convex/ai.ts"
      via: "useAction(api.ai.extractRecipeFromImage)"
      pattern: "useAction.*api\\.ai"
    - from: "src/app/recipe/scan/index.tsx"
      to: "src/contexts/WizardContext.tsx"
      via: "useWizard().updateData"
      pattern: "updateData"
---

<objective>
Build camera capture screen with recipe extraction

Purpose: Create the camera UI that captures recipe photos and sends them to Gemini for extraction. After extraction, the user is navigated to the existing recipe wizard with pre-populated data.

Output: Working camera screen with frame overlay that captures photos, extracts via Gemini, and navigates to review/edit in wizard.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-ai-features/05-CONTEXT.md
@.planning/phases/05-ai-features/05-RESEARCH.md
@.planning/phases/05-ai-features/05-01-SUMMARY.md

# Existing patterns
@src/app/recipe/create/_layout.tsx
@src/contexts/WizardContext.tsx
@src/constants/theme.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create frame overlay component</name>
  <files>src/components/recipe/RecipeFrameOverlay.tsx</files>
  <action>
Create a simple overlay component that shows a rectangular frame guide over the camera preview. This helps users position the recipe within the capture area.

File: src/components/recipe/RecipeFrameOverlay.tsx

Design:
- Absolutely positioned over camera view
- Semi-transparent dark border around frame
- Clear center area (recipe positioning zone)
- Corner brackets or rounded corners for frame indication
- "Position recipe within frame" hint text below frame
- Use Colors from theme for consistency

Implementation approach:
- Use View with position: 'absolute', full coverage
- Create 4 border Views (top, bottom, left, right) with semi-transparent background
- Center area remains transparent
- Add corner accent Views for visual frame indication
- Text hint at bottom

Keep it simple - per CONTEXT.md, Claude has discretion on exact visual design.
  </action>
  <verify>
Component renders without errors when imported.
  </verify>
  <done>RecipeFrameOverlay component exists and provides visual guide for recipe positioning</done>
</task>

<task type="auto">
  <name>Task 2: Create camera scan screen</name>
  <files>src/app/recipe/scan/index.tsx, src/app/recipe/scan/_layout.tsx, app.json</files>
  <action>
Create the camera capture screen with Gemini extraction integration.

**1. Update app.json for camera permission:**
Add to plugins array (if not present):
```json
["expo-camera", { "cameraPermission": "Allow MealPlan to take photos of recipes for extraction" }]
```

**2. Create layout file: src/app/recipe/scan/_layout.tsx**
Wrap with WizardProvider (reuse existing pattern from recipe/create/_layout.tsx):
```typescript
import { Stack } from 'expo-router';
import { Colors } from '@/constants/theme';
import { WizardProvider } from '@/contexts/WizardContext';

export default function ScanRecipeLayout() {
  return (
    <WizardProvider>
      <Stack screenOptions={{
        headerStyle: { backgroundColor: Colors.surface },
        headerTintColor: Colors.text,
        contentStyle: { backgroundColor: Colors.background },
      }}>
        <Stack.Screen name="index" options={{ title: 'Scan Recipe', headerShown: false }} />
      </Stack>
    </WizardProvider>
  );
}
```

**3. Create camera screen: src/app/recipe/scan/index.tsx**

Key features:
- CameraView from expo-camera with ref for takePictureAsync
- Permission handling (request on mount, show button if denied)
- RecipeFrameOverlay positioned over camera
- Capture button at bottom
- Processing state with "Extracting recipe..." spinner
- 15-second timeout using Promise.race
- Error state with retry option
- On success: call updateData() with extracted recipe, then router.push('/recipe/create')
- Gallery option button (uses existing expo-image-picker)

Flow:
1. User sees camera with frame overlay
2. User taps capture button
3. Show spinner "Extracting recipe..."
4. Call Gemini action with base64 image
5. On success: populate wizard data, navigate to /recipe/create
6. On error/timeout: show error message with retry button

Per CONTEXT.md:
- Immediate processing after capture (no preview/retake)
- 15-second timeout before giving up
- Error message: "Couldn't extract recipe. Try again with better lighting?"
- Camera opens by default, gallery option available

Gallery option:
- Add small "Gallery" button in corner
- Use launchImageLibraryAsync from expo-image-picker (already installed)
- Same extraction flow after image selected
  </action>
  <verify>
1. `npx expo start` - app builds without errors
2. Navigate to scan screen (will add entry point in Plan 4)
3. Camera permission prompt appears
4. Camera preview shows with frame overlay
  </verify>
  <done>Camera scan screen captures photos, sends to Gemini, populates wizard, and handles errors with 15-second timeout</done>
</task>

<task type="auto">
  <name>Task 3: Add gallery fallback option</name>
  <files>src/app/recipe/scan/index.tsx</files>
  <action>
Add a gallery picker option to the camera screen for users who prefer to select an existing photo.

In the camera screen, add:
1. Import launchImageLibraryAsync from expo-image-picker (already installed in project)
2. Add "Gallery" button in the UI (e.g., top-right corner or next to capture button)
3. On press: launch image library with options { base64: true, quality: 0.8 }
4. If image selected: run same extraction flow as camera capture

This provides flexibility for users who have already photographed a recipe or prefer gallery selection.

Implementation note: expo-image-picker is already installed (used in recipe image upload), so no new dependencies needed.
  </action>
  <verify>
Gallery button visible on camera screen. Tapping opens image picker.
  </verify>
  <done>Users can either capture new photo OR select from gallery for recipe extraction</done>
</task>

</tasks>

<verification>
1. `npx expo start` builds and runs without errors
2. Camera permission prompt works correctly
3. Camera preview displays with frame overlay visible
4. Capture button triggers extraction (will show API error until key is configured)
5. Gallery button opens image picker
6. 15-second timeout functions (test with slow/no network)
7. Error messages display correctly
</verification>

<success_criteria>
- Camera screen exists at /recipe/scan route
- Frame overlay guides recipe positioning
- Photos capture and send to Gemini action
- Gallery fallback option works
- 15-second timeout with friendly error message
- Successful extraction navigates to /recipe/create with pre-filled data
</success_criteria>

<output>
After completion, create `.planning/phases/05-ai-features/05-02-SUMMARY.md`
</output>
